name: CI/CD - CarStoreView (Tests + SonarCloud + Deploy EC2)

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  test_and_sonar:
    name: Build and analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu' # Alternative distribution options are available.
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build and analyze
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=lehhh_Lehhh_CarList

  build_and_push:
    name: Build & Push Docker (ECR)
    runs-on: ubuntu-latest
    needs: [test_and_sonar]
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            us-east-2

      - uses: aws-actions/amazon-ecr-login@v2
        id: ecr

      - name: Build & push
        id: build
        env:
          REGISTRY: ${{ steps.ecr.outputs.registry }}
          REPO: car-view
          TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          IMAGE_URI="${REGISTRY}/${REPO}:${TAG}"
          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

  deploy:
    name: Deploy EC2
    runs-on: ubuntu-latest
    needs: [build_and_push]
    steps:
      - uses: actions/checkout@v4

      - name: Upload docker-compose.yml to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: ${{ secrets.EC2_APP_DIR }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            APP_DIR="${{ secrets.EC2_APP_DIR }}"
            cd "$APP_DIR"
  
            cat > .env <<EOF
            APP_IMAGE=${{ needs.build_and_push.outputs.image_uri }}
            SERVER_PORT=${{ secrets.SERVER_PORT }}
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            FLYWAY_ENABLED=${{ secrets.FLYWAY_ENABLED }}
            JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO }}
            CORE_BASE_URL=${{ secrets.CORE_BASE_URL }}
            DB_PORT_PUBLISHED=${{ secrets.DB_PORT_PUBLISHED }}
            APP_PORT_PUBLISHED=${{ secrets.APP_PORT_PUBLISHED }}
            JWT_PUBLIC_KEY=${{ secrets.JWT_PUBLIC_KEY }}
            EOF
  
            APP_IMAGE="${{ needs.build_and_push.outputs.image_uri }}"
            ECR_REGISTRY="$(echo "$APP_IMAGE" | cut -d/ -f1)"
            
            docker network inspect carstore_net >/dev/null 2>&1 || docker network create carstore_net
  
            aws ecr get-login-password --region "us-east-2" \
              | docker login --username AWS --password-stdin "$ECR_REGISTRY"
  
            docker compose --env-file .env pull
            docker compose --env-file .env up -d --no-build
            docker image prune -f
